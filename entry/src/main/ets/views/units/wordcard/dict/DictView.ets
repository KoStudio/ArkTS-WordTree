import { IconButton } from "../../../../app/views/buttons/IconButton"
import { CSoundHelper } from "../../../../common/components/Sounds/Cloud/Manager/CSoundHelper"
import { AudioPlayer } from "../../../../common/components/Sounds/Player/CAudioPlayer"
import { CopyUtils } from "../../../../common/utils/CopyUtils"
import { getString } from "../../../../common/utils/ResourceUtils"
import { Toast } from "../../../../common/utils/Toast"
import { BaseWord } from "../../../../models/datas/basedict/BaseWord"
import { BaseWordDbAccess } from "../../../../models/datas/basedict/BaseWordDbAccess"
import { TitleItem } from "../../../../models/datas/basedict/utils/BaseWordUtility"
import { MemberManager } from "../../../../models/managers/member/MemberManager"


@ComponentV2
export struct DictView {

  @Param title: string = ''

  @Local isShowTip            : boolean         = false
  @Local baseWord             : BaseWord | null = null
  @Local titleItems           : TitleItem[]     = []
  @Local isVoiceButtonVisible : boolean         = true

  aboutToAppear(): void {
    ///æ— æŸ¥è¯¢æ—¶ï¼Œæ˜¾ç¤ºæç¤º
    this.isShowTip = this.title.length ===0

    this.loadData()
  }

  build() {

    Column() {

      if (this.isShowTip){
        this.buildTipPanel()
      }else{
        this.buildUpPanel()

        this.buildMidPanel()

        this.buildDownPanel()
      }

    }
    .width('100%')
    .backgroundColor($r('app.color.color_dict_bg'))
    .alignItems(HorizontalAlign.Start)
  }


  /// æ ‡é¢˜è¡Œ
  @Builder buildUpPanel(){
  Row() {
   Row(){
     // ä¸»æ ‡é¢˜
     Text(this.title)
       .fontSize(24)
       .minFontScale(0.1)
       .maxLines(1)
       .fontColor($r('app.color.color_dict_title'))

     if (this.isVoiceButtonVisible) {
       IconButton({icon: $r('app.media.btn_voice_1'), iconSize: 28,onClickCallBack: () =>{
         this.actionPlaySound()
       }})
         .margin({ left: 10, right: 5 })


     }
   }

    Blank().layoutWeight(1)

    // å¤åˆ¶æŒ‰é’®
    IconButton({icon: $r('app.media.plus'), iconSize: 22, onClickCallBack: ()=> {
      this.actionCopy()
    }})

  }
  .width('100%')
  .padding({left: 16, right: 16})
  .height(44)
  .border({width: {bottom: 1}, color: $r('app.color.color_line')})
  .justifyContent(FlexAlign.SpaceBetween)
  .alignItems(VerticalAlign.Center)
}

@Builder buildMidPanel(){
  // éŸ³æ ‡
  Text(`${this.baseWord?.pronUs || ''}`)
    .fontSize(16)
    .fontColor($r('app.color.color_dict_subtitle'))
    .margin({ left: 25, top: 5, right: 5 })
    .width('100%')
    .textAlign(TextAlign.Start)
}

@Builder buildTipPanel(){
    Column(){

      // Tip
      Text('ğŸ””ã€æç¤ºã€‘')//ğŸ“ãŠ™ï¸ğŸ…°ï¸ğŸ…±ï¸â—ï¸â€¼ï¸â‡ï¸1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£ğŸ”´ğŸŸ©ğŸŸ¦ğŸŸªğŸ””â™¦ï¸
        .fontSize(24)
        .minFontScale(0.1)
        .maxLines(1)
        .fontColor($r('app.color.colorPrimaryDark'))
        .width('100%')
        .textAlign(TextAlign.Start)


     Column({space: 20}){
       // 1.ç‚¹å‡»å•è¯ï¼Œå¯æŸ¥çœ‹ä¸­æ–‡æ³¨é‡Š
       Text(`1.${getString($r('app.string.base_dict_tip_text'))}`)
         .maxFontSize(22)
         .minFontScale(0.1)
         .maxLines(1)
         .fontColor($r('app.color.colorPrimary'))
         .width('100%')
         .textAlign(TextAlign.Start)


       // 2.ä¸‹æ‹‰åˆ é™¤å•è¯
       Text(`2.ä¸‹æ‹‰é¡µé¢ï¼Œå¯ä»¥åˆ é™¤/æ¢å¤å•è¯`)
         .maxFontSize(22)
         .minFontScale(0.1)
         .maxLines(1)
         .fontColor($r('app.color.colorPrimary'))
         .width('100%')
         .textAlign(TextAlign.Start)
     }
     .width('100%')
     .justifyContent(FlexAlign.Start)
     .margin({left: 10, top: 20})

    }
    .justifyContent(FlexAlign.Start)
    .padding(20)
    .width('100%')
    .height(300)

}


  // è¯æ€§é‡Šä¹‰é¢æ¿
@Builder buildDownPanel(){
  Column({ space: 5 }) {
    ForEach(this.titleItems, (item: TitleItem, index: number) => {
      Row() {
        // è¯æ€§æ ‡ç­¾
        Text(item.pos)
          .fontSize(14)
          .fontColor($r('app.color.color_dict_pos'))
          .margin({ top: 5, right: 5 })

        // è¯ä¹‰è§£é‡Š
        Text(item.title)
          .fontSize(16)
          .fontColor($r('app.color.color_dict_detail'))
          .margin({ top: 5, right: 5 })
          .layoutWeight(1)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis }) // è¶…å‡ºæ˜¾ç¤ºçœç•¥å·
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    })
  }
  .width('100%')
  .margin({ top: 10, bottom: 50 })
}

  // ============================================================
  // åŠ è½½ä¿¡æ¯ï¼ˆå»ºè®®æ”¾åå°çº¿ç¨‹ï¼‰
  // ============================================================
  private async loadData() {
    if (this.title.length === 0) {
      return
    }

    // è½¬æ¢ä¸ºå¯æœç´¢æ–‡æœ¬
    const searchText = this.getSearchableStr(this.title).toLowerCase();

    // æŸ¥è¯¢å•è¯
    this.baseWord = await BaseWordDbAccess.shared.getBaseWordByText(searchText)

    if (this.baseWord !== null && this.baseWord !== undefined) {
      this.titleItems = this.baseWord.getTitleItems()
      
      ///é¢„åŠ è½½å£°éŸ³
      this.preLoadOneSound(this.baseWord.wordEnSoundText)
    }
  }

  // ============================================================
  // å¤„ç†å¯æœç´¢å­—ç¬¦ä¸²ï¼ˆå»æ‰å•å¼•å·åé¢çš„éƒ¨åˆ†ï¼‰
  // ä¾‹å¦‚ï¼šit's â†’ it,  I'm â†’ I,  can't â†’ can
  // ============================================================
  private getSearchableStr(text: string): string {
    let qouteIndex: number = text.indexOf("'");

    if (qouteIndex !== -1) {
      return text.substring(0, qouteIndex);
    }
    return text;
  }

  /**
   * actionCopy: ä»æ ‡é¢˜å’Œå‰¯æ ‡é¢˜è·å–æ–‡æœ¬ï¼Œåˆå¹¶å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚
   */
  public actionCopy(): void {
    let text = this.title
    if (this.baseWord?.pronUs !== null) {
      text += "\n    " + this.baseWord?.pronUs
    }

    if (this.baseWord?.getTitleCnsJoined() !== null) {
      text += "\n" + this.baseWord?.getTitleCnsJoined();
    }

    //æ‹·è´ åˆ° ç²˜è´´æ¿
    CopyUtils.copyText(text)

    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤ºä¿¡æ¯
    Toast.showMessage("å†…å®¹å·²å¤åˆ¶");

  }

  actionPlaySound(){
    ///ä¼šå‘˜æ£€æŸ¥
    if(!MemberManager.shared.checkWordPronUsable(true)){
      return;
    }

    this.playSound(this.baseWord?.wordEnSoundText)
  }

  // é¢„ä¸‹è½½ (æˆ–åˆæˆ) è¯è¯­çš„å£°éŸ³ (è¯è¯­æ¨¡å¼æ—¶)
  async preLoadOneSound(text?: string | null) {
    if (!text) {
      return
    }

    ///ä¼šå‘˜æ£€æŸ¥
    if(!MemberManager.shared.checkWordPronUsable(false)){
      return;
    }

    if (!(await CSoundHelper.isSoundCacheExists(text))) {

      // å¯åŠ¨ï¼ˆä¸‹è½½æˆ–åˆæˆï¼‰å£°éŸ³
      await CSoundHelper.startDownloadOrGenerateSound(text)
    }
  }


  /// [ç›´æ¥]æ’­æ”¾ (æ±‰å­— or è¯è¯­çš„) å£°éŸ³
  async playSound(text?: string | null) {
    if (!text) return;

    ///æ’­æ”¾å£°éŸ³
    await AudioPlayer.shared.play(text)

  }
}


