import {
  PhotoPickerComponent,
  PickerController,
  PickerOptions,
  BaseItemInfo,
  ItemInfo,
  PhotoBrowserInfo,
  ItemType,
  ClickType,
  ReminderMode,
  photoAccessHelper
} from '@kit.MediaLibraryKit'
import { NavBarView } from '../../NavBarView'
import { NavTitleView } from '../../NavTitleView'

@ComponentV2
export struct ImagePickerButton {
  // ======== å¤–éƒ¨å¯é…ç½®å‚æ•° ========
  @Event onImagePicked                 : (uri: string | null) => void                    // é€‰ä¸­å›¾ç‰‡å›è°ƒ
  @Param btnWidth                      : number              = 80                 // æŒ‰é’®å®½åº¦
  @Param btnHeight                     : number              = 80                 // æŒ‰é’®é«˜åº¦
  @Param cornerRadius                  : number              = 12                 // åœ†è§’
  @Param icon                          : Resource            = $r('app.media.addimg') // é»˜è®¤å›¾æ ‡
  @Param bgColor                       : ResourceColor       = Color.Transparent  // æŒ‰é’®èƒŒæ™¯è‰²

  // ======== å†…éƒ¨çŠ¶æ€ ========
  @Local private pickerOptions         : PickerOptions       = new PickerOptions()
  @Local private pickerController      : PickerController    = new PickerController()
  @Local private selectedUri           : string | null       = null               // å½“å‰é€‰ä¸­å›¾ç‰‡ URI
  @Local private preselectedUris       : string[]            = []                 // é¢„é€‰ä¸­åˆ—è¡¨ï¼ˆè‹¥éœ€è¦åŒæ­¥ï¼‰
  @Local private isShowPhotoPicker     : boolean             = false              // æ˜¯å¦æ˜¾ç¤ºä¿å­˜å¼¹çª—

  // ======== ç”Ÿå‘½å‘¨æœŸ ========
  aboutToAppear() {
    // ä»…æ˜¾ç¤ºå›¾ç‰‡
    this.pickerOptions.MIMEType                   = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE
    // æœ€å¤šé€‰ä¸­ä¸€å¼ 
    this.pickerOptions.maxSelectNumber            = 1
    // è¶…å‡ºæ•°é‡æ—¶æé†’æ–¹å¼
    this.pickerOptions.maxSelectedReminderMode    = ReminderMode.TOAST
    // æ”¯æŒæ‹ç…§å…¥å£
    this.pickerOptions.isPhotoTakingSupported     = false
    // è‹¥æœ‰é¢„é€‰ä¸­ URIï¼Œå¯åˆå§‹åŒ–
    if (this.selectedUri) {
      //this.pickerOptions.preselectedUris = [ this.selectedUri ]
    }
    this.pickerOptions.preselectedUris = []
  }

  // ======== æ„å»ºä¸»ç•Œé¢ï¼ˆæŒ‰é’®ï¼‰ ========
  build() {
    // ä½¿ç”¨ bindMenu å¼¹å‡º PhotoPickerComponentï¼ˆä¸ WeightPickerButton ä¸€è‡´ï¼‰
    Image(this.selectedUri || this.icon)
      .width(this.btnWidth)
      .height(this.btnHeight)
      .borderRadius(this.cornerRadius)
      // .objectFit(this.selectedUri ? ImageFit.Cover : ImageFit.Contain)
      .objectFit(ImageFit.Fill)
      .backgroundColor(this.bgColor)
      .clip(true)
      //.bindMenu(this.buildPickerMenu()) // ğŸ”¹ ä½¿ç”¨ bindMenu å¼¹å‡ºé€‰æ‹©å™¨
      .bindSheet($$this.isShowPhotoPicker, this.buildPickerMenu(), {
        detents: [SheetSize.FIT_CONTENT],
        preferType: SheetType.CENTER,//ä½¿ç”¨centeråœ¨Folderä¸Šå±•å¼€æ—¶èƒ½æ­£å¸¸å±…ä¸­æ˜¾ç¤º
        //title: {title:$r('app.string.detail_item_sort_nav_title')} ,
        showClose: false
      })
      .onClick(()=>{
        this.isShowPhotoPicker = true
      })
  }

  // ======== æ„å»º bindMenu å†…å®¹ï¼ˆPhotoPickerComponentï¼‰ ========
  @Builder
  private buildPickerMenu() {
    Column(){

      NavBarView({
        title: $r('app.string.photo_picker_nav_title'),

        // å·¦ä¾§æŒ‰é’®æ•°ç»„
        leftButtons: [
          {
            icon: $r('app.media.back'),
            onClick: () => {
              // this.selectedUri = null
              // this.onImagePicked(null)
              this.isShowPhotoPicker = false
            }
          }
        ],

        // å³ä¾§æŒ‰é’®æ•°ç»„
        rightButtons: [
          {
            icon: $r('app.media.done'),
            onClick: () => {
              this.isShowPhotoPicker = false
            }
          }
        ],
      })
    }
    PhotoPickerComponent({
      pickerOptions        : this.pickerOptions,
      pickerController     : this.pickerController,
      onItemClicked        : (itemInfo: ItemInfo, clickType: ClickType): boolean => this.onItemClicked(itemInfo, clickType),
      onExitPhotoBrowser   : (_info: PhotoBrowserInfo): boolean => this.onExit(_info),
      onPickerControllerReady: (): void => this.onPickerControllerReady()
    })
      .width('100%')
      .height('100%')
  }

  // ======== ç‚¹å‡»èµ„æºå›è°ƒï¼ˆç”± PhotoPickerComponent è°ƒç”¨ï¼‰ ========
  private onItemClicked(itemInfo: ItemInfo, clickType: ClickType): boolean {
    if (!itemInfo || !itemInfo.uri) {
      return false
    }

    const uri = itemInfo.uri

    // ç‚¹å‡»ç›¸æœºé¡¹ï¼šå…è®¸ç³»ç»Ÿæ‹‰èµ·ç›¸æœºï¼ˆè¿”å› trueï¼‰
    if (itemInfo.itemType === ItemType.CAMERA) {
      return true
    }

    // é€‰ä¸­å›¾ç‰‡å¤„ç†
    if (clickType === ClickType.SELECTED) {
      // æ›´æ–°å½“å‰é€‰ä¸­ URI å¹¶å›è°ƒå¤–éƒ¨
      this.selectedUri                   = uri
      this.preselectedUris               = [ uri ]
      this.pickerOptions.preselectedUris = [ uri ]   // ä¿æŒ picker çš„é¢„é€‰ä¸­é¡¹åŒæ­¥
      try { this.onImagePicked(uri) } catch (e) {}
      return true
    }

    // å–æ¶ˆé€‰ä¸­ï¼ˆå¦‚æœéœ€è¦åŒæ­¥é€»è¾‘ï¼Œå¯åœ¨è¿™é‡Œå¤„ç†ï¼‰
    return true
  }

  // ======== PickerController å°±ç»ªå›è°ƒï¼ˆå¯ç”¨äºå¤–éƒ¨æ§åˆ¶ pickerï¼‰ ========
  private onPickerControllerReady(): void {
    // å¯ä»¥åœ¨è¿™é‡Œé€šè¿‡ this.pickerController è°ƒç”¨ setData / setPhotoBrowserItem ç­‰ API
    // ä¾‹å¦‚ï¼šthis.pickerController.setData(DataType.SET_SELECTED_URIS, this.preselectedUris)
  }

  // ======== é€€å‡ºå›¾ç‰‡æµè§ˆå™¨ï¼ˆæˆ– pickerï¼‰ ========
  private onExit(_info: PhotoBrowserInfo): boolean {
    // å…³é—­å¼¹å±‚åæ— éœ€é¢å¤–æ“ä½œï¼ˆbindMenu ä¼šè‡ªåŠ¨æ”¶èµ·ï¼‰
    return true
  }
}